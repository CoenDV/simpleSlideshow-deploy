name: Update Image Digest

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: "Service name (e.g., VideoService, ChatService)"
      image-name:
        required: true
        type: string
        description: "Full image name without tag (e.g., ghcr.io/coendv/group1-videoservice)"
      environment:
        required: true
        type: string
        description: "Environment (prod or test)"
      branch:
        required: true
        type: string
        description: "Branch that was built (main or dev)"
    secrets:
      DEPLOY_REPO_TOKEN:
        required: true
        description: "Personal Access Token with access to deployment repo"

jobs:
  update-digest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout deployment repo
        uses: actions/checkout@v4
        with:
          repository: CoenDV/simpleSlideshow-deploy
          token: ${{ secrets.DEPLOY_REPO_TOKEN }}
          path: deploy-repo

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get image digest
        id: digest
        run: |
          docker pull ${{ inputs.image-name }}:${{ inputs.branch }}
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ inputs.image-name }}:${{ inputs.branch }} | cut -d'@' -f2)
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "Image digest: ${DIGEST}"

      - name: Update kustomization with digest
        working-directory: deploy-repo/overlays/${{ inputs.environment }}
        run: |
          kustomize edit set image ${{ inputs.image-name }}=${{ inputs.image-name }}@${{ steps.digest.outputs.digest }}
          echo "Updated kustomization.yaml:"
          cat kustomization.yaml

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          repository: deploy-repo
          commit_message: "Update ${{ inputs.service-name }} ${{ inputs.environment }} to digest ${{ steps.digest.outputs.digest }}"
          file_pattern: "overlays/${{ inputs.environment }}/kustomization.yaml"
